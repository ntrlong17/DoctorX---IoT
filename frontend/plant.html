<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DoctorX Garden - Plant Nanny Web</title>

  <!-- Chart.js cho v√≤ng tr√≤n ti·∫øn ƒë·ªô -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;

      /* n·ªÅn s·∫Ω ƒë·ªïi theo class theme-... */
      background-color: #000;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      transition: background-image 0.4s ease-in-out, background-color 0.4s ease-in-out;

      color: #0b1f3b;
      padding: 24px 16px 40px;
    }

    /* 4 theme n·ªÅn */
    body.theme-desert   { background-image: url("/static/bg_desert.png"); }
    body.theme-garden   { background-image: url("/static/bg_garden.png"); }
    body.theme-paradise { background-image: url("/static/bg_paradise.png"); }
    body.theme-ocean    { background-image: url("/static/bg_ocean.png"); }

    .top-bar {
      width: 100%;
      max-width: 1100px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    .btn-logout {
      background: #000;
      color: #fff;
    }

    .btn-back {
      background: rgba(255,255,255,0.9);
      color: #111827;
    }

    .garden-wrapper {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.8fr);
      gap: 28px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .garden-wrapper {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(255,255,255,0.92);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      padding: 20px 22px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111827;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 18px;
    }

    /* Plant zone */
    .plant-zone {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .plant-stage-label {
      font-size: 15px;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .plant-mood-text {
      font-size: 13px;
      color: #4b5563;
      text-align: center;
    }

    .plant-avatar-wrapper {
      margin-top: 16px;
      margin-bottom: 10px;
      width: 260px;
      height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .plant-avatar {
      width: 100%;
      height: 100%;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center bottom;
      transition: transform 0.25s ease, filter 0.25s ease;
    }

    /* 4 tr·∫°ng th√°i c·ªßa c√¢y (avatar) */
    .plant-avatar.dry {
      background-image: url("/static/plant_dry.png");
      filter: grayscale(0.2) saturate(0.7);
      transform: translateY(4px) scale(0.95);
    }

    .plant-avatar.growing {
      background-image: url("/static/plant_growing.png");
    }

    .plant-avatar.healthy {
      background-image: url("/static/plant_healthy.png");
    }

    .plant-avatar.blooming {
      background-image: url("/static/plant_bloom.png");
      transform: translateY(-4px) scale(1.03);
    }

    /* Progress circle */
    .progress-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .progress-inner {
      position: relative;
      width: 160px;
      height: 160px;
    }

    .progress-inner canvas {
      width: 160px;
      height: 160px;
    }

    .progress-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
      color: #2563eb;
      text-align: center;
      white-space: nowrap;
    }

    .metrics-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 14px;
      color: #374151;
    }

    .metrics-list li {
      margin-bottom: 6px;
    }

    .metrics-label {
      font-weight: 600;
    }

    .metrics-value {
      font-weight: 700;
      color: #2563eb;
    }

    .streak-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0f172a;
      color: #fef3c7;
      font-size: 12px;
      margin-top: 4px;
    }

    .streak-badge span {
      margin-right: 4px;
    }

    .warn-text {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 8px;
    }

    /* 3 √¥ tr·∫Øng m√¥ ph·ªèng */
    .summary-boxes {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .summary-box {
      background: rgba(255, 255, 255, 0.75);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 8px 16px;
      backdrop-filter: blur(6px);
    }

    .summary-title {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    /* H√†ng n√∫t +100ml & Reset */
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    /* N√∫t xanh n∆∞·ªõc bi·ªÉn pastel */
    .btn-ml {
      background: rgba(59, 130, 246, 0.9);
      color: #f9fafb;
      border: 1px solid #1d4ed8;
    }

    /* N√∫t Reset x√°m trong su·ªët */
    .btn-reset {
      background: rgba(148, 163, 184, 0.85);
      color: #111827;
      border: 1px solid #4b5563;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="btn btn-back" id="btn-back-dashboard">‚Üê Dashboard</button>
    <button class="btn btn-logout" id="btn-logout">ƒêƒÉng xu·∫•t</button>
  </div>

  <div class="garden-wrapper">
    <!-- C·ªòT 1: C√ÇY + PROGRESS H√îM NAY -->
    <section class="card">
      <div class="card-title">V∆∞·ªùn DoctorX</div>
      <div class="card-sub" id="welcome-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>

      <div class="plant-zone">
        <div class="plant-avatar-wrapper">
          <!-- avatar c√¢y, ·∫£nh s·∫Ω ƒë·ªïi theo class -->
          <div class="plant-avatar dry" id="plant-avatar"></div>
        </div>
        <div class="plant-stage-label" id="plant-stage-label">C√¢y ƒëang kh√°t n∆∞·ªõc</div>
        <div class="plant-mood-text" id="plant-mood-text">
          H√£y u·ªëng m·ªôt ng·ª•m n∆∞·ªõc ƒë·ªÉ ‚Äút∆∞·ªõi‚Äù cho c√¢y nh√©.
        </div>
      </div>

      <div class="progress-wrapper">
        <div class="progress-inner">
          <canvas id="chart-today"></canvas>
          <div class="progress-center-text" id="today-center-text">-- / --</div>
        </div>
      </div>

      <!-- 3 √¥ tr·∫Øng m√¥ ph·ªèng -->
      <div class="summary-boxes">
        <!-- √î 1: ƒê√£ m√¥ ph·ªèng + s·ªë ml ƒë√£ u·ªëng -->
        <div class="summary-box">
          <div class="summary-title">ƒê√£ m√¥ ph·ªèng</div>
          <div class="summary-value">
            <span id="sim-amount-text">0</span> ml
          </div>
        </div>

        <!-- √î 2: Tr·∫°ng th√°i c√¢y -->
        <div class="summary-box">
          <div class="summary-title">Tr·∫°ng th√°i c√¢y</div>
          <div class="summary-value" id="plant-state-box-text">
            Kh√¥ h√©o
          </div>
        </div>

        <!-- √î 3: S·ªë ng√†y ƒë√£ th·ª±c hi·ªán -->
        <div class="summary-box">
          <div class="summary-title">S·ªë ng√†y ƒë√£ th·ª±c hi·ªán</div>
          <div class="summary-value">
            <span id="days-count-text">0</span> ng√†y
          </div>
        </div>
      </div>

      <!-- H√†ng n√∫t +100 ml & Reset -->
      <div class="btn-row">
        <button class="btn btn-ml" id="btn-plus-100" data-amount="100">+100 ml</button>
        <button class="btn btn-reset" id="btn-reset">Reset</button>
      </div>

      <p class="warn-text" id="manual-warn"></p>
    </section>

    <!-- C·ªòT 2: L·ªäCH S·ª¨ & STREAK -->
    <section class="card">
      <div class="card-title">L·ªãch s·ª≠ & Streak</div>
      <div class="card-sub">
        D·ª±a tr√™n d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã IoT v√† Doctor.X.
      </div>

      <div>
        <div class="streak-badge">
          <span>üî•</span> <span id="streak-text">Streak: -- ng√†y</span>
        </div>
      </div>

      <div style="margin-top: 16px;" id="history-summary">
        ƒêang t·∫£i l·ªãch s·ª≠...
      </div>
    </section>
  </div>

  <script>
    // ==== C·∫§U H√åNH C∆† B·∫¢N ====
    const DEFAULT_TARGET_ML = 2000;   // fallback n·∫øu kh√¥ng c√≥ target n√†o trong payload
    const STREAK_THRESHOLD = 0.8;     // ‚â• 80% target t√≠nh l√† "ho√†n th√†nh"

    const token = localStorage.getItem("access_token");
    const userEmail = localStorage.getItem("user_email");

    if (!token) {
      window.location.href = "/app";
    }

    const welcomeTextEl = document.getElementById("welcome-text");
    const todayCenterTextEl = document.getElementById("today-center-text");
    const todayAmountTextEl = document.getElementById("today-amount-text"); // c√≥ th·ªÉ null (ƒë√£ b·ªè metrics list)
    const targetTextEl = document.getElementById("target-text");
    const remainingTextEl = document.getElementById("remaining-text");
    const streakTextEl = document.getElementById("streak-text");
    const historySummaryEl = document.getElementById("history-summary");
    const manualWarnEl = document.getElementById("manual-warn");

    const plantAvatarEl = document.getElementById("plant-avatar");
    const plantStageLabelEl = document.getElementById("plant-stage-label");
    const plantMoodTextEl = document.getElementById("plant-mood-text");

    // C√°c √¥ m√¥ ph·ªèng + n√∫t
    const simAmountEl = document.getElementById("sim-amount-text");
    const daysCountEl = document.getElementById("days-count-text");
    const plantStateBoxEl = document.getElementById("plant-state-box-text");
    const btnPlus100 = document.getElementById("btn-plus-100");
    const btnReset = document.getElementById("btn-reset");

    // Bi·∫øn m√¥ ph·ªèng: ml ƒë√£ u·ªëng & s·ªë ng√†y
    let simMl = 0;
    let simDays = 0;

    function updateSimUI() {
      if (simAmountEl) simAmountEl.textContent = simMl.toString();
      if (daysCountEl) daysCountEl.textContent = simDays.toString();
    }

    if (userEmail) {
      const namePart = userEmail.split("@")[0];
      welcomeTextEl.textContent = `Xin ch√†o, ${namePart || userEmail}! M·ªói ng·ª•m n∆∞·ªõc c·ªßa b·∫°n s·∫Ω t∆∞·ªõi cho c√¢y.`;
    } else {
      welcomeTextEl.textContent = "Xin ch√†o! M·ªói ng·ª•m n∆∞·ªõc c·ªßa b·∫°n s·∫Ω t∆∞·ªõi cho c√¢y.";
    }

    document.getElementById("btn-logout").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      localStorage.removeItem("user_email");
      window.location.href = "/app";
    });

    document.getElementById("btn-back-dashboard").addEventListener("click", () => {
      window.location.href = "/dashboard";
    });

    // CHART
    let chartToday = null;
    function createOrUpdateDoughnut(chartRef, ctx, value, max, colorMain) {
      const safeMax = max <= 0 ? 1 : max;
      const v = Math.min(Math.max(value, 0), safeMax);
      const remain = safeMax - v;

      const data = {
        labels: ["ƒê√£ u·ªëng", "C√≤n l·∫°i"],
        datasets: [
          {
            data: [v, remain],
            backgroundColor: [colorMain, "#e5e7eb"],
            borderWidth: 0,
          },
        ],
      };

      const options = {
        cutout: "70%",
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
        },
      };

      if (chartRef && chartRef instanceof Chart) {
        chartRef.data = data;
        chartRef.options = options;
        chartRef.update();
        return chartRef;
      } else {
        return new Chart(ctx, {
          type: "doughnut",
          data,
          options,
        });
      }
    }

    // √Åp d·ª•ng tr·∫°ng th√°i c√¢y + theme n·ªÅn d·ª±a theo ph·∫ßn trƒÉm target
    function updatePlantState(percent) {
      plantAvatarEl.classList.remove("dry", "growing", "healthy", "blooming");
      document.body.classList.remove(
        "theme-desert",
        "theme-garden",
        "theme-paradise",
        "theme-ocean"
      );

      let shortStatus = "Kh√¥ h√©o";

      if (percent <= 0.25) {
        // 0‚Äì25% target: sa m·∫°c + c√¢y kh√¥
        plantAvatarEl.classList.add("dry");
        document.body.classList.add("theme-desert");
        shortStatus = "Kh√¥ h√©o";
        plantMoodTextEl.textContent = "B·∫°n u·ªëng c·ª±c k·ª≥ √≠t. C√¢y ƒëang s·∫Øp h√©o, u·ªëng ngay m·ªôt ly n∆∞·ªõc ƒëi.";
      } else if (percent < 0.75) {
        // 25‚Äì75%: khu v∆∞·ªùn
        plantAvatarEl.classList.add("growing");
        document.body.classList.add("theme-garden");
        shortStatus = "Ph√°t tri·ªÉn";
        plantMoodTextEl.textContent = "B·∫°n ƒëang ƒëi ƒë√∫ng h∆∞·ªõng. U·ªëng th√™m v√†i l·∫ßn n·ªØa l√† ·ªïn.";
      } else if (percent < 1.1) {
        // 75‚Äì110%: thi√™n ƒë∆∞·ªùng
        plantAvatarEl.classList.add("healthy");
        document.body.classList.add("theme-paradise");
        shortStatus = "S·ªëng t·ªët";
        plantMoodTextEl.textContent = "H√¥m nay b·∫°n g·∫ßn nh∆∞ ƒë√£ ƒë·∫°t m·ª•c ti√™u. C·ªë th√™m ch√∫t n·ªØa!";
      } else {
        // >110%: th·ªßy cung
        plantAvatarEl.classList.add("blooming");
        document.body.classList.add("theme-ocean");
        shortStatus = "N·ªü hoa";
        plantMoodTextEl.textContent = "Qu√° ƒë·ªânh! B·∫°n ƒë√£ v∆∞·ª£t m·ª•c ti√™u h√¥m nay!";
      }

      // label tr√™n c√¢y
      plantStageLabelEl.textContent = shortStatus;
      // v√† trong √¥ tr·∫Øng th·ª© 2
      if (plantStateBoxEl) {
        plantStateBoxEl.textContent = shortStatus;
      }
    }

    // T√≠nh streak t·ª´ map ng√†y -> t·ªïng ml
    function computeStreak(dayToTotal, dayToTarget) {
      const today = new Date();
      let streak = 0;
      for (let i = 0; i < 30; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const key = d.toISOString().slice(0, 10);
        const total = dayToTotal[key] || 0;
        const target = dayToTarget[key] || DEFAULT_TARGET_ML;
        const ratio = target > 0 ? total / target : 0;
        if (ratio >= STREAK_THRESHOLD) {
          streak++;
        } else {
          break;
        }
      }
      return streak;
    }

    // ====== LOGIC +100 ml & RESET (m√¥ ph·ªèng ph√≠a client) ======
    if (btnPlus100) {
      btnPlus100.addEventListener("click", () => {
        // c·ªông +100 ml v√†o √¥ tr·∫Øng ƒë·∫ßu ti√™n
        simMl += 100;
        updateSimUI();
      });
    }

    if (btnReset) {
      btnReset.addEventListener("click", () => {
        // N·∫øu ƒëang c√≥ ml > 0: reset ml v·ªÅ 0 v√† +1 ng√†y
        // N·∫øu ƒë√£ 0 m√† b·∫•m Reset l·∫ßn n·ªØa: reset lu√¥n s·ªë ng√†y v·ªÅ 0
        if (simMl > 0) {
          simMl = 0;
          simDays += 1;
        } else {
          simMl = 0;
          simDays = 0;
        }
        updateSimUI();
      });
    }

    // Kh·ªüi t·∫°o UI m√¥ ph·ªèng
    updateSimUI();

    // G·ª≠i ingest th·ªß c√¥ng (v·∫´n d√πng cho IoT th·∫≠t khi b·∫•m +100 ml)
    async function sendManualIntake(amount) {
      manualWarnEl.textContent = "";
      try {
        const devResp = await fetch("/devices", {
          headers: { Authorization: "Bearer " + token },
        });
        const devs = await devResp.json().catch(() => []);
        if (!devResp.ok || !Array.isArray(devs) || devs.length === 0) {
          manualWarnEl.textContent = "Kh√¥ng t√¨m th·∫•y device ƒë·ªÉ g·ª≠i d·ªØ li·ªáu. H√£y t·∫°o device tr∆∞·ªõc.";
          return;
        }
        const dev = devs[0];

        if (!dev.api_key) {
          manualWarnEl.textContent = "Kh√¥ng c√≥ API key cho device. Ki·ªÉm tra l·∫°i c·∫•u h√¨nh backend.";
          return;
        }

        const payload = {
          device_id: dev.device_id,
          api_key: dev.api_key,
          metric_type: "water_intake_ml",
          value: Number(amount),
          payload: {
            source: "web_manual",
            volume_ml: Number(amount),
          },
        };

        const res = await fetch("/ingest/telemetry", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          manualWarnEl.textContent = "Kh√¥ng g·ª≠i ƒë∆∞·ª£c d·ªØ li·ªáu: " + (data.detail || res.status);
          return;
        }

        manualWarnEl.textContent = "ƒê√£ ghi nh·∫≠n +" + amount + " ml. ƒêang c·∫≠p nh·∫≠t l·∫°i c√¢y...";
        await loadGardenData(); // reload s·ªë li·ªáu
      } catch (e) {
        console.error(e);
        manualWarnEl.textContent = "L·ªói m·∫°ng khi g·ª≠i ingest th·ªß c√¥ng.";
      }
    }

    // G·∫Øn sendManualIntake cho c√°c n√∫t .btn-ml (·ªü ƒë√¢y ch·ªâ c√≤n n√∫t +100 ml)
    document.querySelectorAll(".btn-ml").forEach(btn => {
      btn.addEventListener("click", () => {
        const amount = Number(btn.dataset.amount || "0");
        if (amount > 0) {
          sendManualIntake(amount);
        }
      });
    });

    // Load d·ªØ li·ªáu gi·ªëng logic c≈© nh∆∞ng c√≥ th·ªÉ kh√¥ng c√≤n metrics-list
    async function loadGardenData() {
      try {
        // 1. L·∫•y device
        const devResp = await fetch("/devices", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!devResp.ok) {
          historySummaryEl.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch device (" + devResp.status + ").";
          return;
        }
        const devices = await devResp.json();
        if (!Array.isArray(devices) || devices.length === 0) {
          historySummaryEl.textContent = "Ch∆∞a c√≥ device n√†o. H√£y v√†o Dashboard ƒë·ªÉ t·∫°o device.";
          todayCenterTextEl.textContent = "-- / --";
          updatePlantState(0);
          return;
        }
        const firstDeviceId = devices[0].device_id;

        // 2. L·∫•y telemetry
        const telResp = await fetch(`/devices/${encodeURIComponent(firstDeviceId)}/telemetry?limit=200`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!telResp.ok) {
          historySummaryEl.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c telemetry (" + telResp.status + ").";
          return;
        }
        const list = await telResp.json();
        if (!Array.isArray(list) || list.length === 0) {
          historySummaryEl.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu u·ªëng n∆∞·ªõc n√†o t·ª´ device.";
          todayCenterTextEl.textContent = "-- / --";
          updatePlantState(0);
          return;
        }

        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);

        let totalToday = 0;
        let inferredTargetToday = 0;

        const dayToTotal = {};
        const dayToTarget = {};

        list.forEach(t => {
          if (!t.ts) return;
          const dateStr = t.ts.slice(0, 10);

          // t·ªïng daily
          let ml = 0;
          if (typeof t.value === "number") {
            ml = t.value;
          } else if (t.payload && t.payload.volume_ml) {
            ml = Number(t.payload.volume_ml) || 0;
          }
          dayToTotal[dateStr] = (dayToTotal[dateStr] || 0) + ml;

          // target (n·∫øu Doctor.X g·ª≠i target_ml trong payload)
          if (t.payload && t.payload.target_ml) {
            const target = Number(t.payload.target_ml) || 0;
            if (target > 0) {
              dayToTarget[dateStr] = target;
              if (dateStr === todayStr) {
                inferredTargetToday = target;
              }
            }
          }
        });

        totalToday = dayToTotal[todayStr] || 0;
        const targetToday = inferredTargetToday || DEFAULT_TARGET_ML;

        const remaining = Math.max(targetToday - totalToday, 0);
        const percent = targetToday > 0 ? totalToday / targetToday : 0;

        // C·∫≠p nh·∫≠t UI n∆∞·ªõc h√¥m nay (n·∫øu c√≤n d√πng)
        const totalStr = totalToday.toLocaleString("vi-VN");
        const targetStr = targetToday.toLocaleString("vi-VN");
        const remainingStr = remaining.toLocaleString("vi-VN");

        if (todayAmountTextEl) {
          todayAmountTextEl.textContent = totalStr + " ml";
        }
        if (targetTextEl) {
          targetTextEl.textContent = targetStr + " ml";
        }
        if (remainingTextEl) {
          remainingTextEl.textContent = remainingStr + " ml";
        }
        todayCenterTextEl.textContent = `${Math.round(percent * 100)}%`;

        const ctx = document.getElementById("chart-today").getContext("2d");
        chartToday = createOrUpdateDoughnut(chartToday, ctx, totalToday, targetToday, "#22c55e");

        // C·∫≠p nh·∫≠t c√¢y + theme n·ªÅn
        updatePlantState(percent);

        // T√≠nh streak
        const streak = computeStreak(dayToTotal, dayToTarget);
        streakTextEl.textContent = `Streak: ${streak} ng√†y`;

        // T√≥m t·∫Øt l·ªãch s·ª≠ 7 ng√†y g·∫ßn nh·∫•t
        const days = [];
        const historyLines = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          const key = d.toISOString().slice(0, 10);
          days.push(key);
        }
        days.forEach(dStr => {
          const total = dayToTotal[dStr] || 0;
          const target = dayToTarget[dStr] || DEFAULT_TARGET_ML;
          const ratio = target > 0 ? total / target : 0;
          let status = "";
          if (ratio >= 1) status = "‚úÖ";
          else if (ratio >= STREAK_THRESHOLD) status = "üü°";
          else status = "‚ö†Ô∏è";

          historyLines.push(
            `${dStr}: ${total.toLocaleString("vi-VN")} / ${target.toLocaleString("vi-VN")} ml ${status}`
          );
        });

        historySummaryEl.innerHTML =
          "<p><b>7 ng√†y g·∫ßn nh·∫•t:</b></p><pre style='font-size:13px; white-space:pre-wrap;'>" +
          historyLines.join("\n") +
          "</pre>";
      } catch (err) {
        console.error(err);
        historySummaryEl.textContent = "L·ªói khi t·∫£i d·ªØ li·ªáu: " + err;
      }
    }

    loadGardenData();
  </script>
</body>
</html>
