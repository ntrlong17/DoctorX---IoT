<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DoctorX - H·ªá th·ªëng gi√°m s√°t s·ª©c kh·ªèe</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 200px;
      padding-bottom: 40px;
      background-image: url("/static/Theme.png");
      background-size: cover;
    }

    .portal-wrapper {
      width: 900px;
      max-width: 95vw;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      position: relative;
      overflow: visible;
    }

    .portal-left {
      width: 40%;
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      color: #fff;
      padding: 40px 40px 40px 60px;
      display: none; /* t·∫°m ·∫©n n·∫øu b·∫°n ch∆∞a mu·ªën d√πng b√™n tr√°i */
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    .portal-left-content {
      max-width: 360px;
    }

    .portal-logo {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 1px;
      margin-bottom: 24px;
      line-height: 1.4;
    }

    .portal-title {
      font-size: 22px;
      font-weight: 700;
      line-height: 1.4;
      text-transform: uppercase;
    }

    .portal-sub {
      margin-top: 24px;
      font-size: 14px;
      opacity: 0.95;
    }

    .portal-left-circle {
      position: absolute;
      right: -40px;
      top: 50%;
      transform: translateY(-50%);
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .portal-left-circle-inner {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .logo-doctorx {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }

    .portal-right {
      width: 100%;
      padding: 32px 40px 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    #auth-card {
      position: relative;
    }

    .hello-title {
      font-size: 32px;
      font-weight: 800;
      text-align: center;
      color: #1565c0;
      margin-top: 40px;
      margin-bottom: 8px;
    }

    .hello-sub {
      margin-top: 4px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #0b1f3b;
      text-align: center;
    }

    .form-group {
      margin-bottom: 14px;
    }

    #auth-card label {
      font-size: 14px;
      font-weight: 600;
      color: #0b1f3b;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #333;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid #d0d7de;
      padding: 4px 14px;
      background: #f9fafb;
    }

    .input-wrapper span.icon {
      margin-right: 8px;
      color: #888;
      font-size: 14px;
    }

    .input-wrapper input {
      border: none;
      outline: none;
      background: transparent;
      flex: 1;
      font-size: 14px;
      padding: 6px 0;
    }

    button.primary-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      background: #1565c0;
      color: #fff;
      padding: 10px 32px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: background 0.18s ease, transform 0.08s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-top: 6px;
    }

    button.primary-btn:hover {
      background: #c62828;
      transform: translateY(-1px);
    }

    button.primary-btn:active {
      transform: translateY(0);
    }

    .toggle-link {
      margin-top: 10px;
      font-size: 13px;
      color: #1565c0;
      cursor: pointer;
      text-align: center;
    }

    .toggle-link:hover {
      text-decoration: underline;
    }

    .auth-extra-links {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
    }

    .auth-extra-links a {
      color: #1565c0;
      text-decoration: none;
      margin: 0 4px;
    }

    .auth-extra-links a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }

    .small-text {
      font-size: 12px;
      color: #777;
      margin-top: 10px;
      text-align: center;
    }

    /* DASHBOARD */
    #dashboard-card {
      margin-top: 24px;
      border-top: 1px solid #eee;
      padding-top: 18px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .section-sub {
      font-size: 13px;
      margin-bottom: 12px;
      color: #666;
    }

    input, select {
      font-family: inherit;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d0d7de;
      font-size: 13px;
      background: #fff;
      min-width: 220px;
    }

    .section-block {
      margin-bottom: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
    }

    th {
      background: #f5f5f5;
    }

    .status-low { color: #c62828; font-weight: 600; }
    .status-almost { color: #ef6c00; font-weight: 600; }
    .status-done { color: #2e7d32; font-weight: 600; }

    /* LOG CLIENT */
    .log-card {
      width: 1100px;
      max-width: 95vw;
      margin-top: 18px;
      padding: 10px 14px;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      border-radius: 10px;
      font-size: 12px;
      max-height: 160px;
      overflow: auto;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      display: none; /* b·∫≠t l√™n n·∫øu mu·ªën xem log */
    }

    .log-card-title {
      color: #fff;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* Logo tr√≤n n·ªïi ph√≠a tr√™n khung */
    .auth-logo-float {
      position: absolute;
      top: -80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .auth-logo-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #ffffffee;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    }

    .auth-logo-circle img {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }

    @media (max-width: 900px) {
      .portal-wrapper {
        flex-direction: column;
      }
      .portal-left, .portal-right {
        width: 100%;
      }
      .portal-left {
        border-radius: 18px 18px 0 0;
      }
      .portal-left-circle {
        display: none;
      }
    }
  </style>
</head>
<body>
<div class="portal-wrapper">
  <!-- B√äN TR√ÅI: BRAND (c√≥ th·ªÉ d√πng sau) -->
  <div class="portal-left">
    <div class="portal-logo">
      Welcome to the arena of discipline
    </div>
    <div class="portal-left-circle">
      <div class="portal-left-circle-inner">
        <img src="/static/doctorx_logo.png" alt="DoctorX logo" class="logo-doctorx" />
      </div>
    </div>
  </div>

  <!-- B√äN PH·∫¢I: AUTH + DASHBOARD -->
  <div class="portal-right">
    <div id="auth-card">
      <div class="auth-logo-float">
        <div class="auth-logo-circle">
          <img src="/static/doctorx_logo.png" alt="DoctorX logo" />
        </div>
      </div>

      <h1 class="hello-title">XIN CH√ÄO!</h1>
      <p class="hello-sub">
        ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng. N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, h√£y ƒëƒÉng k√Ω tr∆∞·ªõc nh√©.
      </p>

      <!-- LOGIN FORM -->
      <div id="login-section">
        <div class="form-group">
          <label>Email</label>
          <div class="input-wrapper">
            <span class="icon">üë§</span>
            <input type="email" id="login-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" />
          </div>
        </div>
<div class="form-group">
  <label>M·∫≠t kh·∫©u</label>
  <div class="input-wrapper">
    <span class="icon">üîí</span>
    <input
      type="password"
      id="login-pass"
      placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
      maxlength="72"
    />
  </div>
</div>

        <button class="primary-btn" onclick="login()">ƒêƒÇNG NH·∫¨P</button>
        <div class="auth-extra-links">
          <a href="/forgot-password">Qu√™n m·∫≠t kh·∫©u?</a>
          <span>‚Ä¢</span>
          <a href="#" onclick="forgotEmail(event)">Qu√™n t√†i kho·∫£n?</a>
        </div>

        <div class="toggle-link" onclick="showRegister()">
          Ch∆∞a c√≥ t√†i kho·∫£n? <b>ƒêƒÉng k√Ω</b>
        </div>
      </div>

      <!-- REGISTER FORM -->
      <div id="register-section" class="hidden">
        <div class="form-group">
          <label>Email</label>
          <div class="input-wrapper">
            <span class="icon">üìß</span>
            <input type="email" id="reg-email" placeholder="Nh·∫≠p email ƒë·ªÉ ƒëƒÉng k√Ω" />
          </div>
        </div>
<div class="form-group">
  <label>M·∫≠t kh·∫©u</label>
  <div class="input-wrapper">
    <span class="icon">üîë</span>
    <input
      type="password"
      id="reg-pass"
      placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
      maxlength="72"
    />
  </div>
</div>

        <button class="primary-btn" onclick="register()">ƒêƒÇNG K√ù</button>
        <div class="toggle-link" onclick="showLogin()">
          ƒê√£ c√≥ t√†i kho·∫£n? <b>ƒêƒÉng nh·∫≠p</b>
        </div>
      </div>

      <p class="small-text" id="auth-status"></p>
    </div>

    <!-- DASHBOARD (sau khi login) -->
    <div id="dashboard-card" class="hidden">
      <div class="section-block">
        <div class="section-title">Xin ch√†o, <span id="current-email"></span></div>
        <div class="section-sub">
          Qu·∫£n l√Ω thi·∫øt b·ªã ƒëo n∆∞·ªõc, xem log v√† t·ªïng l∆∞·ª£ng n∆∞·ªõc u·ªëng theo ng√†y.
        </div>
        <button class="primary-btn" onclick="logout()">ƒêƒÇNG XU·∫§T</button>
      </div>

      <div class="section-block">
        <div class="section-title">1. T·∫°o thi·∫øt b·ªã m·ªõi</div>
        <div class="section-sub">
          M·ªói ‚Äúc·ªëc‚Äù ho·∫∑c h·ªá th·ªëng ƒëo n∆∞·ªõc t∆∞∆°ng ·ª©ng v·ªõi m·ªôt device.
        </div>
        <div class="form-group">
          <label>Device ID</label>
          <div class="input-wrapper">
            <span class="icon">üè∑</span>
            <input type="text" id="dev-id" placeholder="vd: water_dev_01" />
          </div>
        </div>
        <div class="form-group">
          <label>T√™n hi·ªÉn th·ªã</label>
          <div class="input-wrapper">
            <span class="icon">üìå</span>
            <input type="text" id="dev-name" placeholder="vd: C·ªëc n∆∞·ªõc b√†n l√†m vi·ªác" />
          </div>
        </div>
        <button class="primary-btn" onclick="createDevice()">T·∫†O DEVICE</button>
        <p class="small-text">
          API key c·ªßa device ƒëang ch·ªçn:
          <b><span id="dev-api-key"></span></b>
        </p>
      </div>

      <div class="section-block">
        <div class="section-title">2. Danh s√°ch thi·∫øt b·ªã</div>
        <button class="primary-btn" style="padding: 6px 18px; font-size: 13px;" onclick="loadDevices()">
          T·∫£i danh s√°ch devices
        </button>
        <div style="margin-top:8px;">
          <label>Ch·ªçn device</label>
          <select id="device-select" onchange="onDeviceChange()">
            <option value="">-- Ch∆∞a ch·ªçn --</option>
          </select>
        </div>
      </div>

      <div class="section-block">
        <div class="section-title">3. Telemetry g·∫ßn ƒë√¢y</div>
        <button class="primary-btn" style="padding: 6px 18px; font-size: 13px;" onclick="loadTelemetry()">
          T·∫£i 20 b·∫£n ghi g·∫ßn nh·∫•t
        </button>
        <div id="telemetry-container" style="margin-top:10px;"></div>
      </div>

      <div class="section-block">
        <div class="section-title">4. T·ªïng l∆∞·ª£ng n∆∞·ªõc theo ng√†y</div>
        <div class="section-sub">
          M·∫∑c ƒë·ªãnh xem ng√†y h√¥m nay (UTC). C√≥ th·ªÉ ch·ªânh target n·∫øu mu·ªën.
        </div>
        <div class="form-group">
          <label>Ng√†y (YYYY-MM-DD, ƒë·ªÉ tr·ªëng = h√¥m nay)</label>
          <div class="input-wrapper">
            <span class="icon">üìÖ</span>
            <input type="text" id="summary-date" placeholder="vd: 2025-11-27" />
          </div>
        </div>
        <div class="form-group">
          <label>Target (ml, ƒë·ªÉ tr·ªëng = payload / 2000ml)</label>
          <div class="input-wrapper">
            <span class="icon">üéØ</span>
            <input type="number" id="summary-target" placeholder="vd: 2000" />
          </div>
        </div>
        <button class="primary-btn" style="padding: 6px 18px; font-size: 13px;" onclick="loadDailySummary()">
          Xem t·ªïng trong ng√†y
        </button>
        <div id="summary-container" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="log-card">
  <div class="log-card-title">Client log</div>
  <pre id="log"></pre>
</div>

<script>
  // G·ªçi c√πng domain v·ªõi backend (local ho·∫∑c Render)
  // "" nghƒ©a l√† d√πng origin hi·ªán t·∫°i (t·ª± ƒë·ªông ƒë√∫ng cho c·∫£ 127.0.0.1 v√† onrender.com)
  const API_BASE = "";

  let accessToken = null;
  let currentEmail = null;
  let devicesCache = [];

  function log(msg) {
    const box = document.getElementById("log");
    if (!box) return;
    box.textContent += msg + "\n";
    box.scrollTop = box.scrollHeight;
  }

  function showRegister() {
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("register-section").classList.remove("hidden");
  }

  function showLogin() {
    document.getElementById("register-section").classList.add("hidden");
    document.getElementById("login-section").classList.remove("hidden");
  }

  async function register() {
    const email = document.getElementById("reg-email").value.trim();
    const pass = document.getElementById("reg-pass").value.trim();
    if (!email || !pass) {
      alert("Nh·∫≠p email v√† m·∫≠t kh·∫©u ƒë·ªÉ ƒëƒÉng k√Ω");
      return;
    }
    try {
      const res = await fetch(API_BASE + "/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pass }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert("ƒêƒÉng k√Ω th·∫•t b·∫°i: " + (data.detail || res.status));
        log("Register failed: " + JSON.stringify(data));
      } else {
        alert("ƒêƒÉng k√Ω th√†nh c√¥ng, b√¢y gi·ªù h√£y ƒëƒÉng nh·∫≠p.");
        log("Registered: " + JSON.stringify(data));
        showLogin();
        document.getElementById("login-email").value = email;
      }
    } catch (e) {
      alert("L·ªói m·∫°ng khi ƒëƒÉng k√Ω");
      log("Register error: " + e);
    }
  }

  async function login() {
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-pass").value.trim();
    if (!email || !pass) {
      alert("Nh·∫≠p email v√† m·∫≠t kh·∫©u ƒë·ªÉ ƒëƒÉng nh·∫≠p");
      return;
    }
    try {
      const body = new URLSearchParams();
      body.append("username", email);
      body.append("password", pass);

      const res = await fetch(API_BASE + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body,
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + (data.detail || res.status));
        log("Login failed: " + JSON.stringify(data));
        return;
      }

      const token = data.access_token;
      if (!token) {
        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: kh√¥ng nh·∫≠n ƒë∆∞·ª£c token.");
        log("Login missing token: " + JSON.stringify(data));
        return;
      }

      // L∆∞u token + email cho c√°c trang kh√°c d√πng
      localStorage.setItem("access_token", token);
      localStorage.setItem("user_email", email);

      log("Login success, redirect to /dashboard");

      // Sang trang dashboard th·∫≠t
      window.location.href = "/dashboard";
    } catch (e) {
      alert("L·ªói m·∫°ng khi ƒëƒÉng nh·∫≠p");
      log("Login error: " + e);
    }
  }

  function forgotEmail(event) {
    event.preventDefault();
    alert(
      "N·∫øu b·∫°n qu√™n email/t√†i kho·∫£n, h√£y li√™n h·ªá qu·∫£n tr·ªã h·ªá th·ªëng ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£."
    );
  }

  function logout() {
    accessToken = null;
    currentEmail = null;
    devicesCache = [];
    const dash = document.getElementById("dashboard-card");
    if (dash) dash.classList.add("hidden");
    const statusEl = document.getElementById("auth-status");
    if (statusEl) statusEl.textContent = "ƒê√£ ƒëƒÉng xu·∫•t.";
    const sel = document.getElementById("device-select");
    if (sel)
      sel.innerHTML = '<option value="">-- Ch∆∞a ch·ªçn --</option>';
    const telDiv = document.getElementById("telemetry-container");
    if (telDiv) telDiv.innerHTML = "";
    const sumDiv = document.getElementById("summary-container");
    if (sumDiv) sumDiv.innerHTML = "";
    const apiSpan = document.getElementById("dev-api-key");
    if (apiSpan) apiSpan.textContent = "";
    log("Logout.");
  }

  function authHeader() {
    if (!accessToken) return {};
    return { Authorization: "Bearer " + accessToken };
  }

  async function createDevice() {
    if (!accessToken) {
      alert("H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
      return;
    }
    const deviceId = document.getElementById("dev-id").value.trim();
    const name = document.getElementById("dev-name").value.trim();
    if (!deviceId) {
      alert("Nh·∫≠p device_id");
      return;
    }
    try {
      const res = await fetch(API_BASE + "/devices", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...authHeader(),
        },
        body: JSON.stringify({ device_id: deviceId, name }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert("T·∫°o device th·∫•t b·∫°i: " + (data.detail || res.status));
        log("Create device failed: " + JSON.stringify(data));
        return;
      }
      alert("T·∫°o device th√†nh c√¥ng. API key ƒë∆∞·ª£c hi·ªÉn th·ªã ph√≠a d∆∞·ªõi.");
      log("Device created: " + JSON.stringify(data));
      await loadDevices();
      const sel = document.getElementById("device-select");
      if (sel) {
        sel.value = data.device_id;
        onDeviceChange();
      }
    } catch (e) {
      alert("L·ªói m·∫°ng khi t·∫°o device");
      log("Create device error: " + e);
    }
  }

  async function loadDevices() {
    if (!accessToken) {
      alert("H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
      return;
    }
    try {
      const res = await fetch(API_BASE + "/devices", {
        headers: { ...authHeader() },
      });
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        alert("L·∫•y danh s√°ch device th·∫•t b·∫°i");
        log("List devices failed: " + JSON.stringify(data));
        return;
      }
      devicesCache = data;
      const sel = document.getElementById("device-select");
      if (!sel) return;
      sel.innerHTML = '<option value="">-- Ch·ªçn device --</option>';
      for (const d of data) {
        const opt = document.createElement("option");
        opt.value = d.device_id;
        opt.textContent = d.device_id + (d.name ? " (" + d.name + ")" : "");
        sel.appendChild(opt);
      }
      if (data.length > 0) {
        sel.value = data[0].device_id;
        onDeviceChange();
      }
      log("Loaded devices: " + JSON.stringify(data));
    } catch (e) {
      alert("L·ªói m·∫°ng khi t·∫£i devices");
      log("Load devices error: " + e);
    }
  }

  function onDeviceChange() {
    const sel = document.getElementById("device-select");
    const id = sel ? sel.value : "";
    const span = document.getElementById("dev-api-key");
    const dev = devicesCache.find((d) => d.device_id === id);
    if (dev) {
      span.textContent = dev.api_key;
    } else {
      span.textContent = "";
    }
  }

  async function loadTelemetry() {
    if (!accessToken) {
      alert("H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
      return;
    }
    const sel = document.getElementById("device-select");
    const id = sel ? sel.value : "";
    if (!id) {
      alert("Ch·ªçn device tr∆∞·ªõc");
      return;
    }
    try {
      const res = await fetch(
        API_BASE + `/devices/${encodeURIComponent(id)}/telemetry?limit=20`,
        { headers: { ...authHeader() } }
      );
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        alert("L·∫•y telemetry th·∫•t b·∫°i");
        log("Get telemetry failed: " + JSON.stringify(data));
        return;
      }
      const div = document.getElementById("telemetry-container");
      if (!div) return;
      if (!data.length) {
        div.innerHTML = "<p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>";
        return;
      }
      let html =
        "<table><thead><tr><th>Th·ªùi gian</th><th>Value (ml)</th><th>Payload</th></tr></thead><tbody>";
      for (const row of data) {
        html += `<tr>
          <td>${row.ts}</td>
          <td>${row.value ?? ""}</td>
          <td><code>${JSON.stringify(row.payload || {})}</code></td>
        </tr>`;
      }
      html += "</tbody></table>";
      div.innerHTML = html;
      log("Telemetry loaded, count=" + data.length);
    } catch (e) {
      alert("L·ªói m·∫°ng khi t·∫£i telemetry");
      log("Telemetry error: " + e);
    }
  }

  async function loadDailySummary() {
    if (!accessToken) {
      alert("H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
      return;
    }
    const sel = document.getElementById("device-select");
    const id = sel ? sel.value : "";
    if (!id) {
      alert("Ch·ªçn device tr∆∞·ªõc");
      return;
    }
    const day = document.getElementById("summary-date").value.trim();
    const target = document.getElementById("summary-target").value.trim();
    const params = new URLSearchParams();
    params.append("device_id", id);
    if (day) params.append("date_str", day);
    if (target) params.append("target_ml", target);

    try {
      const res = await fetch(
        API_BASE + `/water-intake/daily?` + params.toString(),
        { headers: { ...authHeader() } }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert("L·∫•y t·ªïng trong ng√†y th·∫•t b·∫°i: " + (data.detail || res.status));
        log("Daily summary failed: " + JSON.stringify(data));
        return;
      }
      const div = document.getElementById("summary-container");
      if (!div) return;
      const cls =
        data.status === "done"
          ? "status-done"
          : data.status === "almost"
          ? "status-almost"
          : "status-low";
      div.innerHTML = `
        <p><b>Ng√†y:</b> ${data.date}</p>
        <p><b>T·ªïng ƒë√£ u·ªëng:</b> ${data.total_intake_ml} ml</p>
        <p><b>Target:</b> ${data.target_ml} ml</p>
        <p><b>C√≤n thi·∫øu:</b> ${data.remaining_ml} ml</p>
        <p><b>Ho√†n th√†nh:</b> ${(data.percentage * 100).toFixed(1)}%</p>
        <p><b>Tr·∫°ng th√°i:</b> <span class="${cls}">${data.status}</span></p>
      `;
      log("Daily summary: " + JSON.stringify(data));
    } catch (e) {
      alert("L·ªói m·∫°ng khi t·∫£i t·ªïng trong ng√†y");
      log("Daily summary error: " + e);
    }
  }
</script>
</body>
</html>
